# PDF寄附金情報抽出ツール（OCR + GiNZA）

## 概要（処理概要）

本ツールは、**PDF形式の寄附金受領書等の書類**から、以下の情報を自動抽出し、CSVファイルとして出力する Python スクリプトです。

### 抽出項目
- 市区町村名（自治体名）
- 日付（令和表記のみ）
- 金額（円）

### 処理の流れ
1. PDFファイルを画像に変換（pdf2image + Poppler）
2. 画像を前処理（グレースケール化）
3. Tesseract OCR により日本語テキストを抽出
4. spaCy + GiNZA による自然言語解析
5. 正規表現・NER（固有表現抽出） を併用して以下を抽出  
   - 市区町村名  
   - 日付  
   - 金額
6. 結果を `output/output.csv` に出力
7. 処理ログを `logs/log.log` に出力

---

## 処理概要（抽出ロジック詳細）

OCR により取得した全文テキストに対して、  
**正規表現**と **自然言語処理（spaCy + GiNZA）** を併用し、  
市区町村名・日付・金額を以下の優先順位で抽出しています。

---

### 市区町村名の抽出ロジック

市区町村名は、**正規表現と GiNZA の固有表現認識（NER）を組み合わせ**、  
複数候補が存在する場合の誤抽出を避けるため、以下の優先順位で決定します。

#### 使用手法
- **正規表現**  
  - 都道府県名 + 市区町村（市・区・町・村）を対象
- **GiNZA（spaCy）**
  - 固有表現ラベル：`City`, `Province`, `GPE`, `LOC`
  - 末尾が「市・区・町・村」で終わるもののみ採用

#### 優先順位

1. **正規表現で複数件検出された場合**
   - *2件目* を採用  
   （帳票上、1件目は住所や発行元であることが多いため）

2. **GiNZAで複数件検出された場合（重複除外後）**
   - *2件目* を採用

3. **GiNZAで複数件検出された場合（重複あり）**
   - 出現頻度が最も高い市区町村名を採用

4. **正規表現で1件のみ検出された場合**
   - その1件を採用

5. **GiNZAで1件のみ検出された場合**
   - その1件を採用

6. **いずれも該当しない場合**
   - 空欄とする

---

### 日付の抽出ロジック

日付は、**GiNZA による日付表現抽出を主軸**とし、  
補助的に正規表現を用いて取得します。

#### 抽出条件
- 「令和」表記のみを対象
- 「平成」表記は除外
- 日が省略されている場合は **1日** として扱う

#### 処理手順
1. OCRテキストを整形（改行・全角スペース除去）
2. GiNZA の `Date` ラベルを持つ固有表現を抽出
3. 以下を満たすもののみ候補とする
   - `○年○月○日` または `○年○月` 形式
   - 「平成」が含まれない
   - 同じ年号が「令和」で記載されている
4. 正規表現で `令和○年○月○日` 形式の日付も追加抽出
5. 複数候補がある場合  
   - 月日を `100 × 月 + 日` として数値化
   - **最も早い日付**を採用

#### 採用ルール
- 候補が存在しない場合は空欄
- 候補が1件の場合はそのまま採用
- 候補が複数の場合は最小の月日を持つ日付を採用

---

### 金額の抽出ロジック

金額は、**正規表現のみ**を用いて抽出します。

#### 対象表記例
- `寄附金額 10,000円`
- `合計金額 ￥50,000 円`
- `金額 3000円`

#### 抽出ルール
1. 以下のキーワードを含む金額表記を対象  
   - `寄附金額` / `合計金額` / `金額` / `請求額`
2. `¥` / `￥` の有無は問わない
3. カンマ付き数字を許容
4. **最初に一致した金額のみを採用**
5. カンマを除去し、数値文字列として出力

---

### 抽出結果の確定

各ページごとに以下の順で抽出を行い、  
取得できなかった項目は空欄として CSV に出力します。

1. 市区町村名  
2. 日付  
3. 金額  

---

## フォルダ構成

```text
/
├─ input/          # 処理対象のPDFを格納
├─ output/
│  └─ output.csv   # 抽出結果
├─ logs/
│  └─ log.log      # 実行ログ
├─ main.py         # 本スクリプト
└─ README.md
```

## インストール手順

本ツールは **Windows 環境**を前提としています。

---

### 1. Python環境の構築（必須）
1. Python3.12のインストーラーをダウンロードします。
      - https://www.python.org/downloads/windows/
  
2. 1でダウンロードしたインストーラーを起動してPythonをインストールします。デフォルトの設定のまま次へを押してダウンロードを行ってください。

3. `confirm_python.bat`をダブルクリックで実行して下記のような表示が出ればOKです。
```
Python 3.12.10
Python はインストールされています。
```

4. 次に`setup_env.bat`をダブルクリックで実行します。


### 2. Tesseract OCR のインストール（必須）
OCR処理に使用します。

1. ダウンロード先（Windows）:Tesseract OCR（UB Mannheim版）からインストーラーをダウンロードします。
     - https://github.com/UB-Mannheim/tesseract/wiki
     - - インストーラーの場所とインストーラー各画面の入力内容は下記を参照ください。
        - https://gammasoft.jp/blog/tesseract-ocr-install-on-windows/#download

2. ダウンロードした上記のインストーラーをダブルクリックで実行します。

3. インストール完了後`C:\Program Files\Tesseract-OCR\tesseract.exe`のファイルがあれば完了です。

### 3. Poppler のインストール（必須）
PDF を画像に変換するために使用します。

1. ダウンロード先（Windows）:Poppler for WindowsからZIPファイルをダウンロードします。
     - https://github.com/oschwartz10612/poppler-windows/releases/
     - ダウンロードリンクの場所等は下記のSTEP1を参照ください。
       - https://blog.nyanco.me/howto-poppler-windows11/#toc2

2. `C:\poppler`というフォルダを作成します。

3. 1でダウンロードしたZIPファイルを解凍し、解凍してできたフォルダから下記のフォルダを`C:\poppler`の配下に移動します。
    - Library
    - share

## プログラムを実行方法
1. `input`フォルダに PDF を配置します。
2. `execute.bat`を実行します。
3. `output/output.csv` に結果が出力されます。
4. `logs/log.log` に詳細な解析ログが出力されます。